name: Fuzz Upload Action
author: Asymmetric Research
description: Upload fuzzing data to FuzzCorp
branding:
  icon: upload-cloud
  color: blue

inputs:
  upload_type:
    description: 'Type of data to upload (asset|bundle|corpus)'
    required: true
  upload_path:
    description: Path to file/directory to upload
    required: true
  upload_args:
    description: 'Arguments/flags to pass to `fuzz-up upload`'
    required: false
    default: ''

runs:
  using: composite
  steps:
    - name: Validate inputs
      shell: bash
      env:
        UPLOAD_TYPE: ${{ inputs.upload_type }}
        UPLOAD_PATH: ${{ inputs.upload_path }}
        UPLOAD_ARGS: ${{ inputs.upload_args }}
      run: |
        # Validate type input
        case "$UPLOAD_TYPE" in
          asset|bundle|corpus)
            echo "Type: $UPLOAD_TYPE"
            ;;
          *)
            echo "Error: Invalid type '$UPLOAD_TYPE'. Must be one of: asset, bundle, corpus"
            exit 1
            ;;
        esac

        # Validate path exists
        if [ ! -e "$UPLOAD_PATH" ]; then
          echo "Error: Path '$UPLOAD_PATH' does not exist"
          exit 1
        fi

        # Validate required flags
        if [ "$UPLOAD_TYPE" = "corpus" ]; then
          if ! echo "$UPLOAD_ARGS" | grep -qE -- '--seed-corpus-group([[:space:]]+[^[:space:]-]|=[^[:space:]]+)'; then
            echo "Error: Corpus uploads must include '--seed-corpus-group <value>' or '--seed-corpus-group=<value>'"
            exit 1
          fi
        fi

        if [ "$UPLOAD_TYPE" = "asset" ]; then
          if ! echo "$UPLOAD_ARGS" | grep -qE -- '--lineage([[:space:]]+[^[:space:]-]|=[^[:space:]]+)'; then
            echo "Error: Asset uploads args must include '--lineage <value>' or '--lineage=<value>'"
            exit 1
          fi
        fi

        echo "Path: $UPLOAD_PATH"
        echo "Args: $UPLOAD_ARGS"
    
    - name: Validate env
      shell: bash
      run: |
        # Validate required environment variables
        if [ -z "$FUZZ_API_ORIGIN" ] || [ -z "$FUZZ_ORGANIZATION" ] || [ -z "$FUZZ_PROJECT" ] || [ -z "$FUZZ_USER" ] || [ -z "$FUZZ_PASSWORD" ]; then
          echo "Error: Missing required FuzzCorp credentials. Set FUZZ_API_ORIGIN, FUZZ_ORGANIZATION, FUZZ_PROJECT, FUZZ_USER, and FUZZ_PASSWORD environment variables."
          exit 1
        fi

    - name: Detect platform
      id: platform
      shell: bash
      run: |
        case "${{ runner.os }}" in
          Linux)
            echo "os=linux" >> "$GITHUB_OUTPUT"
            ;;
          macOS)
            echo "os=darwin" >> "$GITHUB_OUTPUT"
            ;;
          *)
            echo "Error: Unsupported OS '${{ runner.os }}'. fuzz-up only supports Linux and macOS."
            exit 1
            ;;
        esac

        case "${{ runner.arch }}" in
          X64)
            echo "arch=amd64" >> "$GITHUB_OUTPUT"
            ;;
          ARM64)
            echo "arch=arm64" >> "$GITHUB_OUTPUT"
            ;;
          *)
            echo "Error: Unsupported architecture '${{ runner.arch }}'. fuzz-up only supports X64 (amd64) and ARM64."
            exit 1
            ;;
        esac

    - name: Install cosign
      uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad #v4.0.0

    - name: Download fuzz-up
      shell: bash
      env:
        BINARY_NAME: fuzz-up_${{ steps.platform.outputs.os }}_${{ steps.platform.outputs.arch }}
        INSTALL_DIR: ${{ runner.temp }}/fuzz-up-bin
      run: |
        echo "Downloading fuzz-up for ${{ steps.platform.outputs.os }} ${{ steps.platform.outputs.arch }}..."

        if ! gh release download --repo asymmetric-research/fuzz-up --pattern "$BINARY_NAME" --pattern "${BINARY_NAME}.sig"; then
          echo "Error: Failed to download fuzz-up release"
          exit 1
        fi

        if [ ! -f "$BINARY_NAME" ]; then
          echo "Error: Downloaded file '$BINARY_NAME' not found"
          exit 1
        fi

        if [ ! -f "${BINARY_NAME}.sig" ]; then
          echo "Error: Signature file '${BINARY_NAME}.sig' not found"
          exit 1
        fi

        if ! gh api repos/asymmetric-research/fuzz-up/contents/cosign.pub --jq '.content' | base64 -d > cosign.pub; then
          echo "Error: Failed to download cosign public key"
          exit 1
        fi

        echo "Verifying fuzz-up signature..."
        if ! cosign verify-blob --key cosign.pub --signature "${BINARY_NAME}.sig" "$BINARY_NAME"; then
          echo "Error: Signature verification failed for fuzz-up binary"
          exit 1
        fi

        mkdir -p "$INSTALL_DIR"
        mv "$BINARY_NAME" "$INSTALL_DIR/fuzz-up"
        chmod +x "$INSTALL_DIR/fuzz-up"
        echo "$INSTALL_DIR" >> "$GITHUB_PATH"

        # Cleanup verification files
        rm -f cosign.pub "${BINARY_NAME}.sig"

        echo "fuzz-up downloaded and verified successfully"

    - name: Log into FuzzCorp
      shell: bash
      run: |
        fuzz-up user login

    - name: Upload to FuzzCorp
      shell: bash
      env:
        UPLOAD_TYPE: ${{ inputs.upload_type }}
        UPLOAD_PATH: ${{ inputs.upload_path }}
        UPLOAD_ARGS: ${{ inputs.upload_args }}
      run: |
        fuzz-up upload "$UPLOAD_TYPE" "$UPLOAD_PATH" $UPLOAD_ARGS
